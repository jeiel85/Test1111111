<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ì°¬ì–‘ ì•…ë³´ ì°¾ê¸° ì™„ì„±íŒ ğŸµ</title>
    <style>
        /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
        body { margin: 0; padding: 0; font-family: -apple-system, sans-serif; background-color: #f5f5f5; display: flex; flex-direction: column; height: 100vh; }
        header { background-color: white; padding: 15px; text-align: center; font-weight: bold; font-size: 18px; position: sticky; top: 0; z-index: 10; border-bottom: 1px solid #ddd; }
        main { flex: 1; overflow-y: auto; padding: 20px; padding-bottom: 80px; /* í•˜ë‹¨ ë²„íŠ¼ ê³µê°„ í™•ë³´ */ }
        textarea { width: 100%; height: 150px; border: 1px solid #ddd; border-radius: 8px; padding: 10px; font-size: 16px; box-sizing: border-box; resize: none; }
        .btn-search { width: 100%; padding: 15px; background-color: #0070f3; color: white; border: none; border-radius: 8px; font-size: 18px; font-weight: bold; margin-top: 10px; cursor: pointer; }
        .result-area { margin-top: 30px; }
        .sheet-music-card { background: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; }
        .sheet-music-card img { width: 100%; height: auto; border-radius: 4px; min-height: 100px; background: #f0f0f0; }
        .sheet-title { margin-bottom: 10px; font-weight: bold; color: #333; text-align: left; }
        .error-msg { color: red; font-size: 14px; margin-top: 5px; }
        
        /* ìƒˆë¡œ ì¶”ê°€ëœ í•˜ë‹¨ ê³ ì • ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
        .bottom-bar {
            position: fixed; bottom: 0; left: 0; right: 0;
            background: white; padding: 15px;
            border-top: 1px solid #eee;
            display: flex; justify-content: center;
            display: none; /* ì²˜ìŒì—” ìˆ¨ê¹€ */
        }
        .btn-download-all {
            width: 100%; padding: 15px;
            background-color: #28a745; /* ì´ˆë¡ìƒ‰ */
            color: white; border: none; border-radius: 8px;
            font-size: 18px; font-weight: bold; cursor: pointer;
        }
    </style>
</head>
<body>

    <header>ì´ë²ˆ ì£¼ ì°¬ì–‘ ì½˜í‹° ğŸ¶</header>

    <main>
        <div style="background: white; padding: 20px; border-radius: 12px;">
            <h3>ê³¡ ë¦¬ìŠ¤íŠ¸ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”</h3>
            <textarea id="song-input" placeholder="ì˜ˆ:&#13;&#10;276 í–‡ì‚´ë³´ë‹¤ ë°ê²Œ&#13;&#10;123 ë‹¹ì‹ ì€ ì§€ê¸ˆ ì–´ë””ë¡œ">
276 í–‡ì‚´ë³´ë‹¤ ë°ê²Œ ë¹›ë‚˜ëŠ” ì£¼ì˜
123 ë‹¹ì‹ ì€ ì§€ê¸ˆ ì–´ë””ë¡œ 
168 í•˜ë‚˜ë‹˜ì€ ë„ˆë¥¼ ë§Œë“œì‹  ë¶„
165 ì„¸ìƒì´
136 ë‚˜ì˜ ì£¼ë‹˜ì€
367 ì§€ê·¹íˆ ë†’ì€ ì£¼ë‹˜ì˜</textarea>
            <button class="btn-search" onclick="startSearch()">ì•…ë³´ ì°¾ê¸° ğŸ”</button>
        </div>

        <div id="result-container" class="result-area"></div>
    </main>

    <div class="bottom-bar" id="download-bar">
        <button class="btn-download-all" onclick="downloadAll()">ì „ì²´ ì•…ë³´ ìˆœì„œëŒ€ë¡œ ì €ì¥ ğŸ“¥</button>
    </div>

    <script>
        // ì‹œë„í•´ë³¼ í™•ì¥ì ëª©ë¡ (ìˆœì„œëŒ€ë¡œ ì‹œë„í•¨)
        const EXTENSIONS = ['.jpg', '.png', '.gif', '.bmp', '.jpeg'];
        
        // ì°¾ì€ ì´ë¯¸ì§€ë“¤ì˜ ì •ë³´ë¥¼ ìˆœì„œëŒ€ë¡œ ì €ì¥í•  ë°°ì—´ (ë‹¤ìš´ë¡œë“œìš©)
        let foundImages = [];

        function startSearch() {
            const inputText = document.getElementById('song-input').value;
            const resultContainer = document.getElementById('result-container');
            const downloadBar = document.getElementById('download-bar');
            
            resultContainer.innerHTML = ""; // ê²°ê³¼ì°½ ì´ˆê¸°í™”
            foundImages = []; // ì°¾ì€ ì´ë¯¸ì§€ ëª©ë¡ ì´ˆê¸°í™”
            downloadBar.style.display = 'none'; // ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ ìˆ¨ê¹€

            const lines = inputText.split('\n').filter(line => line.trim() !== "");
            if (lines.length === 0) return alert("ê³¡ ë¦¬ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");

            // ê° ì¤„ì— ëŒ€í•´ ì²˜ë¦¬ ì‹œì‘
            lines.forEach((line, index) => {
                const match = line.match(/^(\d+)/); // ìˆ«ì ì¶”ì¶œ
                if (match) {
                    const songNumber = match[1];
                    const songTitle = line.substring(songNumber.length).trim();
                    
                    // 1. ì¹´ë“œ UI ë¼ˆëŒ€ ë§Œë“¤ê¸°
                    const card = document.createElement('div');
                    card.className = 'sheet-music-card';
                    card.innerHTML = `<div class="sheet-title">${index + 1}. No. ${songNumber} ${songTitle}</div>`;
                    
                    // 2. ì´ë¯¸ì§€ íƒœê·¸ ë§Œë“¤ê¸° (ì²˜ìŒì—” srcê°€ ì—†ìŒ)
                    const imgTag = document.createElement('img');
                    imgTag.alt = `${songNumber} ì•…ë³´ ë¡œë”©ì¤‘...`;
                    card.appendChild(imgTag);
                    resultContainer.appendChild(card);

                    // 3. ì´ë¯¸ì§€ ì°¾ê¸° ì‹œì‘ (í•µì‹¬ ë¡œì§!)
                    tryLoadImage(imgTag, songNumber, 0, (finalSrc) => {
                        // ì´ë¯¸ì§€ë¥¼ ì„±ê³µì ìœ¼ë¡œ ì°¾ì•˜ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì½œë°± í•¨ìˆ˜
                        // ìˆœì„œë¥¼ ë³´ì¥í•˜ê¸° ìœ„í•´ ì¸ë±ìŠ¤ì™€ íŒŒì¼ëª…ì„ í•¨ê»˜ ì €ì¥
                        const fileExt = finalSrc.substring(finalSrc.lastIndexOf('.'));
                        const fileName = `${String(index + 1).padStart(2, '0')}ë²ˆ_${songNumber}${fileExt}`;
                        
                        // ë°°ì—´ì˜ ì˜¬ë°”ë¥¸ ìœ„ì¹˜ì— ì €ì¥ (ë¹„ë™ê¸°ë¼ ìˆœì„œê°€ ì„ì¼ ìˆ˜ ìˆìœ¼ë¯€ë¡œ ì¸ë±ìŠ¤ ì‚¬ìš©)
                        foundImages[index] = { url: finalSrc, name: fileName };

                        // ëª¨ë“  ì´ë¯¸ì§€ë¥¼ ë‹¤ ì°¾ì•˜ëŠ”ì§€ í™•ì¸í•˜ì—¬ ë‹¤ìš´ë¡œë“œ ë²„íŠ¼ í‘œì‹œ
                        const foundCount = foundImages.filter(item => item !== undefined).length;
                        if (foundCount > 0 && foundCount === lines.length) {
                             downloadBar.style.display = 'flex';
                        }
                    });
                }
            });
        }

        /**
         * ì¬ê·€ í•¨ìˆ˜: ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ë•Œê¹Œì§€ í™•ì¥ìë¥¼ ë°”ê¿”ê°€ë©° ì‹œë„í•œë‹¤.
         * @param imgElement - srcë¥¼ ë„£ì„ ì´ë¯¸ì§€ íƒœê·¸
         * @param songNum - ê³¡ ë²ˆí˜¸
         * @param extIndex - í˜„ì¬ ì‹œë„í•  í™•ì¥ìì˜ ì¸ë±ìŠ¤
         * @param onSuccess - ì„±ê³µ ì‹œ ì‹¤í–‰í•  í•¨ìˆ˜
         */
        function tryLoadImage(imgElement, songNum, extIndex, onSuccess) {
            // ëª¨ë“  í™•ì¥ìë¥¼ ë‹¤ ì‹œë„í–ˆëŠ”ë° ì‹¤íŒ¨í•œ ê²½ìš°
            if (extIndex >= EXTENSIONS.length) {
                imgElement.alt = "âŒ ì´ë¯¸ì§€ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.";
                imgElement.parentElement.innerHTML += `<p class="error-msg">âš ï¸ íŒŒì¼ ì—†ìŒ (jpg, png, gif ë“± í™•ì¸ í•„ìš”)</p>`;
                return;
            }

            const currentExt = EXTENSIONS[extIndex];
            const trySrc = `images/${songNum}${currentExt}`; // ì˜ˆ: images/276.jpg

            // ì´ë¯¸ì§€ ë¡œë“œ ì‹œë„
            const tempImg = new Image();
            tempImg.onload = function() {
                // ì„±ê³µ! ì‹¤ì œ ì´ë¯¸ì§€ íƒœê·¸ì— ì£¼ì†Œ ì ìš©
                imgElement.src = trySrc;
                imgElement.alt = `${songNum} ì•…ë³´`;
                onSuccess(trySrc); // ì„±ê³µ ì½œë°± í˜¸ì¶œ
            };
            tempImg.onerror = function() {
                // ì‹¤íŒ¨! ë‹¤ìŒ í™•ì¥ìë¡œ ë„˜ì–´ê°€ì„œ ë‹¤ì‹œ ì‹œë„ (ì¬ê·€ í˜¸ì¶œ)
                console.log(`${trySrc} ì‹¤íŒ¨, ë‹¤ìŒ í™•ì¥ì ì‹œë„...`);
                tryLoadImage(imgElement, songNum, extIndex + 1, onSuccess);
            };
            tempImg.src = trySrc; // ë¡œë“œ ì‹œì‘ íŠ¸ë¦¬ê±°
        }

        /**
         * ì¼ê´„ ë‹¤ìš´ë¡œë“œ í•¨ìˆ˜: ì°¾ì€ ì´ë¯¸ì§€ë“¤ì„ ìˆœì„œëŒ€ë¡œ ë‹¤ìš´ë¡œë“œí•œë‹¤.
         */
        function downloadAll() {
            if (foundImages.length === 0) return alert("ì €ì¥í•  ì•…ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.");
            if (!confirm(`${foundImages.length}ê°œì˜ ì•…ë³´ë¥¼ ìˆœì„œëŒ€ë¡œ ì €ì¥í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(íŒì—… ì°¨ë‹¨ì´ í•´ì œë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤)`)) return;

            // 0.5ì´ˆ ê°„ê²©ìœ¼ë¡œ í•˜ë‚˜ì”© ë‹¤ìš´ë¡œë“œ ì‹¤í–‰ (ë¸Œë¼ìš°ì € ì°¨ë‹¨ ë°©ì§€)
            foundImages.forEach((imgInfo, idx) => {
                if(!imgInfo) return; // í˜¹ì‹œ ì‹¤íŒ¨í•œ ì´ë¯¸ì§€ê°€ ìˆìœ¼ë©´ ê±´ë„ˆëœ€
                setTimeout(() => {
                    const link = document.createElement('a');
                    link.href = imgInfo.url;
                    link.download = imgInfo.name; // ì˜ˆ: 01ë²ˆ_276.jpg
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }, idx * 500); // 0ms, 500ms, 1000ms... ê°„ê²©ìœ¼ë¡œ ì‹¤í–‰
            });
        }
    </script>
</body>
</html>
